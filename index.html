<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SAT Math – امتحان تجريبي (44 سؤال | 70 دقيقة)</title>
  <style>
    :root {
      --bg:#f6f7fb; --card:#fff; --muted:#6b7280; --border:#e5e7eb;
      --primary:#111827; --primary-weak:#e5e7eb;
      --acc:#3730a3; --acc-bg:#eef2ff;
      --good:#16a34a; --good-bg:#ecfdf5;
      --bad:#dc2626;  --bad-bg:#fef2f2;
    }
    * { box-sizing: border-box; }
    body { font-family: system-ui, "Segoe UI", Tahoma, Arial; background:var(--bg); margin:0; color:#222; }
    .container { max-width: 980px; margin: 0 auto; padding: 20px; }
    .card { background:var(--card); border:1px solid var(--border); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,0.05); padding: 20px; }
    h1,h2,h3 { margin: 0 0 12px; }
    .muted { color: var(--muted); }
    .divider { height:1px; background:#eee; margin:14px 0; }
    .header { display:flex; gap: 16px; align-items:center; justify-content:space-between; margin-bottom: 12px; }
    .timer { font-weight:800; color:#0f172a; background:#f1f5f9; padding:6px 10px; border-radius:10px; min-width: 110px; text-align:center; }

    .form-grid { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .form-grid .full { grid-column: 1 / -1; }
    label { font-size: 14px; color:#111; display:block; margin-bottom:6px; }
    input[type="text"], input[type="email"], input[type="tel"] {
      width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px; background:#fff;
    }

    .modules { display:flex; gap:10px; flex-wrap: wrap; margin: 10px 0 6px; }
    .mod-btn { border:1px solid var(--border); background:#fff; color:#111827; padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600; }
    .mod-btn.active { background:#111827; color:#fff; }
    .mod-btn:disabled { opacity: .5; cursor:not-allowed; }

    .q-box { border:1px solid var(--border); border-radius:12px; padding:16px; background:#fafafa; }
    .q-head { display:flex; gap:10px; align-items:center; justify-content:space-between; }
    .q-type { background:#e0f2fe; color:#075985; padding:4px 10px; border-radius:999px; font-size:12px; }
    .q-text { font-size:18px; margin-top:8px; }
    .choices { display:grid; gap:10px; margin-top:12px; }
    .choice { display:flex; align-items:center; gap:8px; padding:10px 12px; border:1px solid var(--border); border-radius:12px; cursor:pointer; background:#fff; transition: .2s; }
    .choice:hover { border-color:#c7d2fe; background:#f8fafc; }
    .choice input { transform: scale(1.2); }

    .num-input { margin-top:12px; display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .num-input input {
      width: 260px; padding:10px 12px; border:1px solid var(--border); border-radius:10px; font-size:16px;
    }
    .note { font-size:12px; color:var(--muted); }

    .controls { display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:16px; flex-wrap: wrap; }
    button { border:none; border-radius:12px; padding:10px 14px; cursor:pointer; font-weight:700; }
    .btn { background:var(--primary); color:#fff; }
    .btn.secondary { background:var(--primary-weak); color:var(--primary); }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .progress { font-size:14px; color:#374151; }

    .result { margin-top:18px; border-top:1px dashed var(--border); padding-top:16px; }
    .tag { display:inline-block; padding:4px 8px; border-radius:999px; background:var(--acc-bg); color:var(--acc); font-size:12px; margin-left:6px; }

    .correct { border-color: var(--good) !important; background: var(--good-bg) !important; }
    .wrong   { border-color: var(--bad) !important;  background: var(--bad-bg) !important; }
    .legend { display:flex; gap:10px; font-weight:700; }
    .good { color: var(--good); } .bad { color: var(--bad); }

    .start .hint { color:var(--muted); }

    .flex-between { display:flex; align-items:center; justify-content:space-between; gap:10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1>SAT Math – امتحان تجريبي</h1>
        <div class="muted">موديولين × 22 سؤال = 44 سؤال • الوقت الكلي: 70 دقيقة</div>
      </div>
      <div class="timer" id="timer">70:00</div>
    </div>

    <div class="modules" id="modulesBar"></div>

    <div id="examCard" class="card">
      <!-- شاشة البدء: نموذج بيانات الطالب -->
      <div id="startScreen">
        <h2>بيانات الطالب</h2>
        <p class="hint">يُفضّل كتابة الهاتف مع مفتاح الدولة (مثال: +974 55xxxxxx)</p>
        <div class="divider"></div>
        <div class="form-grid">
          <div class="full">
            <label for="studentName">الاسم الكامل</label>
            <input id="studentName" type="text" placeholder="الاسم كما سيظهر في التقرير" />
          </div>
          <div>
            <label for="studentEmail">الإيميل</label>
            <input id="studentEmail" type="email" placeholder="name@example.com" />
          </div>
          <div>
            <label for="studentPhone">الهاتف</label>
            <input id="studentPhone" type="tel" placeholder="+974 55xxxxxx" />
          </div>
        </div>
        <div class="divider"></div>
        <div class="flex-between">
          <p class="hint">عند الضغط على <b>ابدأ الامتحان</b> يبدأ العد التنازلي (70:00). لا تظهر أي نتيجة أثناء الحل.</p>
          <button id="startBtn" class="btn">ابدأ الامتحان</button>
        </div>
      </div>

      <!-- محتوى الامتحان -->
      <div id="examContent" style="display:none;">
        <div id="questionBox" class="q-box"></div>

        <div class="controls">
          <div>
            <button id="prevBtn" class="btn secondary">السابق</button>
            <button id="nextBtn" class="btn secondary">التالي</button>
          </div>
          <div class="progress" id="progressText">موديول 1 • السؤال 1 من 22 (إجمالي 1 من 44)</div>
          <button id="submitBtn" class="btn">إنهاء الامتحان</button>
        </div>

        <div id="result" class="result" style="display:none;"></div>
      </div>
    </div>

    <p class="muted" style="margin-top:10px;">
      يدعم نوعي الأسئلة: <b>اختيار متعدد</b> و<b>إجابة رقمية</b>. لا تُعرض الدرجات إلا بعد الإنهاء أو انتهاء الوقت.
    </p>
  </div>

  <script>
    // =========================
    // 0) إعدادات عامة
    // =========================
    const EXAM_MINUTES = 70; // الوقت الكلي للموديولين
    const TOTAL_SECONDS = EXAM_MINUTES * 60;

    // =========================
    // أدوات مساعدة
    // =========================
    function fmtTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }
    function parseNumber(value) {
      if (value === null || value === undefined) return null;
      const v = String(value).replace(/,/g, ".").trim();
      if (v === "") return null;
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }
    function approximatelyEqual(a, b, tol = 0) { return Math.abs(a - b) <= tol; }
    function escapeCSV(val) {
      const s = String(val ?? "");
      if (/[",\n]/.test(s)) return '"' + s.replace(/"/g, '""') + '"';
      return s;
    }
    function nowISO() { return new Date().toISOString(); }

    // =========================
    // 1) بنك الأسئلة (44 سؤال: 22 لكل موديول)
    // التوزيع لكل موديول: 8 جبر، 6 دوال، 4 هندسة، 4 إحصاء
    // =========================
    const module1Questions = [
      // جبر (8)
      { domain:"جبر", type:"numeric", text:"حل المعادلة 3x + 5 = 20. أوجد قيمة x.", correctValue:5, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"numeric", text:"حل المعادلة 2x − 7 = 9. أوجد x.", correctValue:8, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"numeric", text:"حل المعادلة x/3 + 4 = 9. أوجد x.", correctValue:15, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"mcq", text:"بسّط 2(x + 3) − x.", choices:["x + 6","x + 3","3x + 6","x − 6"], answerIndex:0 },
      { domain:"جبر", type:"numeric", text:"أوجد الجذر الموجب للمعادلة x² − 9 = 0.", correctValue:3, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"numeric", text:"إذا كان 4 أقلام تكلف 6 ريالات، فما ثمن القلم الواحد؟", correctValue:1.5, numericOptions:{tolerance:0,decimals:2} },
      { domain:"جبر", type:"mcq", text:"حل النظام: x + y = 7، و x − y = 1. ما الزوج المرتّب (x, y)؟", choices:["(3,4)","(4,3)","(2,5)","(5,2)"], answerIndex:1 },
      { domain:"جبر", type:"numeric", text:"زادت قيمة 80 بنسبة 25٪. ما القيمة الجديدة؟", correctValue:100, numericOptions:{tolerance:0,decimals:null} },

      // دوال (6)
      { domain:"دوال", type:"numeric", text:"إذا كانت f(x)=2x+1، فأوجد f(4).", correctValue:9, numericOptions:{tolerance:0,decimals:null} },
      { domain:"دوال", type:"mcq", text:"ما ميل المستقيم y = −3x + 5؟", choices:["−3","3","5","−5"], answerIndex:0 },
      { domain:"دوال", type:"numeric", text:"إذا كانت g(x)=x² − 4x، فأوجد g(6).", correctValue:12, numericOptions:{tolerance:0,decimals:null} },
      { domain:"دوال", type:"mcq", text:"أصفار الدالة f(x)=(x − 2)(x + 5) هي:", choices:["{−2, 5}","{2, −5}","{2, 5}","{−2, −5}"], answerIndex:1 },
      { domain:"دوال", type:"numeric", text:"للدالة f(x)=3x − 2، جد x عندما f(x)=10.", correctValue:4, numericOptions:{tolerance:0,decimals:null} },
      { domain:"دوال", type:"mcq", text:"إذا كانت h(x)=x²، فما قيمة h(−3)؟", choices:["9","−9","6","0"], answerIndex:0 },

      // هندسة (4)
      { domain:"هندسة", type:"numeric", text:"مستطيل طوله 8 وعرضه 5. ما مساحته؟", correctValue:40, numericOptions:{tolerance:0,decimals:null} },
      { domain:"هندسة", type:"numeric", text:"دائرة نصف قطرها 7. احسب المحيط (بالقيمة التقريبية).", correctValue:43.98, numericOptions:{tolerance:0.2,decimals:2} },
      { domain:"هندسة", type:"mcq", text:"مجموع قياسات الزوايا الداخلية لأي مثلث يساوي:", choices:["90°","180°","270°","360°"], answerIndex:1 },
      { domain:"هندسة", type:"numeric", text:"مثلث قائم ساقاه 6 و8. ما طول الوتر؟", correctValue:10, numericOptions:{tolerance:0,decimals:null} },

      // إحصاء (4)
      { domain:"إحصاء", type:"numeric", text:"أوجد المتوسط للأعداد: 6، 8، 10، 6.", correctValue:7.5, numericOptions:{tolerance:0,decimals:1} },
      { domain:"إحصاء", type:"mcq", text:"ما الوسيط للقيم: 3، 9، 1، 7؟", choices:["3","5","6","7"], answerIndex:1 },
      { domain:"إحصاء", type:"numeric", text:"ما المنوال للقيم: 4، 2، 4، 5، 2، 4؟", correctValue:4, numericOptions:{tolerance:0,decimals:null} },
      { domain:"إحصاء", type:"mcq", text:"ما احتمال الحصول على عدد زوجي عند رمي نرد منتظم مرة واحدة؟", choices:["1/6","1/3","1/2","2/3"], answerIndex:2 },
    ];

    const module2Questions = [
      // جبر (8)
      { domain:"جبر", type:"numeric", text:"حل 5(x − 2) = 15. جد x.", correctValue:5, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"mcq", text:"أكبر جذر للمعادلة x² − 5x − 14 = 0 هو:", choices:["−2","7","5","14"], answerIndex:1 },
      { domain:"جبر", type:"numeric", text:"حل |x − 3| = 5. أعطِ الحل الأكبر.", correctValue:8, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"mcq", text:"بسّط: x² · x³ =", choices:["x⁵","x⁶","x³","2x⁵"], answerIndex:0 },
      { domain:"جبر", type:"numeric", text:"إذا كان 4 ÷ x = 0.5، فأوجد x.", correctValue:8, numericOptions:{tolerance:0,decimals:null} },
      { domain:"جبر", type:"mcq", text:"حل النظام 3x + 2y = 12 و x − y = 1. قيمة x تساوي:", choices:["2","2.8","3","4"], answerIndex:1 },
      { domain:"جبر", type:"numeric", text:"P = 200(1.05)^t. احسب P عندما t = 2.", correctValue:220.5, numericOptions:{tolerance:0.1,decimals:1} },
      { domain:"جبر", type:"mcq", text:"حل المتباينة 2x + 3 > 9 هو:", choices:["x > 3","x > 6","x < 3","x ≥ 3"], answerIndex:0 },

      // دوال (6)
      { domain:"دوال", type:"mcq", text:"إذا كانت f(x)=(x−1)² + 4، فرأس القطع المكافئ هو:", choices:["(1,4)","(−1,4)","(1,−4)","(0,4)"], answerIndex:0 },
      { domain:"دوال", type:"mcq", text:"إذا f(x)=2x+1 و g(x)=x−3، فما قيمة f(g(5))؟", choices:["3","5","7","9"], answerIndex:1 },
      { domain:"دوال", type:"numeric", text:"ميل المستقيم المار بالنقطتين (2,3) و(5,15) يساوي:", correctValue:4, numericOptions:{tolerance:0,decimals:null} },
      { domain:"دوال", type:"mcq", text:"معادلة المستقيم الذي ميله 3 ويقطع المحور y عند −2 هي:", choices:["y=3x−2","y=3x+2","y=−3x−2","y=−3x+2"], answerIndex:0 },
      { domain:"دوال", type:"numeric", text:"إذا h(x)=1/x، فأوجد h(−0.5).", correctValue:-2, numericOptions:{tolerance:0,decimals:null} },
      { domain:"دوال", type:"mcq", text:"أي الدوال التالية تزداد عندما تزداد x (لجميع x)؟", choices:["y=−x²","y=2^x","y=−|x|","y=−3x"], answerIndex:1 },

      // هندسة (4)
      { domain:"هندسة", type:"numeric", text:"دائرة نصف قطرها 5. احسب المساحة.", correctValue:78.54, numericOptions:{tolerance:0.2,decimals:2} },
      { domain:"هندسة", type:"mcq", text:"ميل المستقيم العمودي على y = (1/2)x + 3 هو:", choices:["−2","2","1/2","−1/2"], answerIndex:0 },
      { domain:"هندسة", type:"numeric", text:"مستطيل أبعاده 9 و12. ما طول القطر؟", correctValue:15, numericOptions:{tolerance:0,decimals:null} },
      { domain:"هندسة", type:"mcq", text:"مجموع قياسات الزوايا الداخلية لأي رباعي يساوي:", choices:["180°","270°","360°","540°"], answerIndex:2 },

      // إحصاء (4)
      { domain:"إحصاء", type:"numeric", text:"ما الوسيط للقيم: 5، 2، 7، 9، 1؟", correctValue:5, numericOptions:{tolerance:0,decimals:null} },
      { domain:"إحصاء", type:"mcq", text:"المدى للقيم: 12، 4، 9، 15 يساوي:", choices:["9","11","12","15"], answerIndex:1 },
      { domain:"إحصاء", type:"numeric", text:"كيس يحوي 3 حمراء، 2 زرقاء، 5 خضراء. احتمال سحب كرة حمراء =", correctValue:0.3, numericOptions:{tolerance:0.01,decimals:2} },
      { domain:"إحصاء", type:"mcq", text:"متوسط أربع قيم يساوي 8. ما مجموع هذه القيم؟", choices:["8","16","24","32"], answerIndex:3 },
    ];

    const exam = {
      modules: [
        { name: "موديول 1", questions: module1Questions },
        { name: "موديول 2", questions: module2Questions },
      ],
      totalDurationMinutes: EXAM_MINUTES
    };

    // =========================
    // 2) الحالة العامة
    // =========================
    let started = false;
    let reviewMode = false;
    let currentModule = 0;
    let currentQuestion = 0;
    let remainingSeconds = TOTAL_SECONDS;
    let timerId = null;

    const totalQuestions = exam.modules.reduce((sum, m) => sum + m.questions.length, 0);

    // إجابات الطالب + أزمنة كل سؤال
    const userAnswers = exam.modules.map(m => m.questions.map(q => null));
    const timeSpent = exam.modules.map(m => m.questions.map(q => 0)); // بالثواني
    let lastEnterTimestamp = null;

    // بيانات الطالب + أوقات
    const student = { name:"", email:"", phone:"" };
    let startedAtISO = null;
    let endedAtISO = null;

    // =========================
    // 3) عناصر DOM
    // =========================
    const timerEl = document.getElementById("timer");
    const startScreen = document.getElementById("startScreen");
    const startBtn = document.getElementById("startBtn");
    const examContent = document.getElementById("examContent");
    const questionBox = document.getElementById("questionBox");
    const modulesBar = document.getElementById("modulesBar");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const submitBtn = document.getElementById("submitBtn");
    const progressText = document.getElementById("progressText");
    const resultEl = document.getElementById("result");

    const nameInput = document.getElementById("studentName");
    const emailInput = document.getElementById("studentEmail");
    const phoneInput = document.getElementById("studentPhone");

    // =========================
    // 4) عرض شريط الموديولات
    // =========================
    function renderModulesBar() {
      modulesBar.innerHTML = "";
      exam.modules.forEach((mod, idx) => {
        const btn = document.createElement("button");
        btn.className = "mod-btn" + (idx === currentModule ? " active" : "");
        btn.textContent = `${mod.name} (${mod.questions.length} سؤال)`;
        btn.disabled = !started;
        btn.addEventListener("click", () => {
          if (!reviewMode) {
            navigateTo(idx, Math.min(currentQuestion, exam.modules[idx].questions.length - 1));
          } else {
            currentModule = idx;
            currentQuestion = Math.min(currentQuestion, exam.modules[idx].questions.length - 1);
            renderQuestion();
          }
        });
        modulesBar.appendChild(btn);
      });
    }

    // =========================
    // 5) تنقّل مع حساب زمن السؤال
    // =========================
    function updateTimeSpent() {
      if (!started || reviewMode || lastEnterTimestamp === null) return;
      const now = Date.now();
      const delta = Math.max(0, Math.round((now - lastEnterTimestamp) / 1000));
      timeSpent[currentModule][currentQuestion] += delta;
      lastEnterTimestamp = now;
    }

    function navigateTo(modIdx, qIdx) {
      updateTimeSpent();
      currentModule = modIdx;
      currentQuestion = qIdx;
      renderQuestion();
    }

    // =========================
    // 6) عرض سؤال
    // =========================
    function globalIndex(modIdx, qIdx) {
      let idx = 0;
      for (let i = 0; i < modIdx; i++) idx += exam.modules[i].questions.length;
      return idx + qIdx + 1; // 1-based
    }

    function renderQuestion() {
      renderModulesBar();

      const mod = exam.modules[currentModule];
      const q = mod.questions[currentQuestion];

      if (!q) {
        questionBox.innerHTML = `
          <div class="q-box">
            <h3>تنبيه</h3>
            <div class="divider"></div>
            <p class="muted">يجب أن يحتوي كل موديول على 22 سؤالًا.</p>
          </div>`;
        prevBtn.disabled = true; nextBtn.disabled = true;
        return;
      }

      let html = `
        <div class="q-head">
          <h2>${mod.name} – السؤال ${currentQuestion + 1} <span class="muted">• المجال: ${q.domain}</span></h2>
          <span class="q-type">${q.type === "mcq" ? "اختيار متعدد" : "إجابة رقمية"}</span>
        </div>
        <div class="divider"></div>
        <div class="q-text">${q.text}</div>
      `;

      if (q.type === "mcq") {
        html += `<div class="choices" id="choices"></div>`;
      } else {
        const val = userAnswers[currentModule][currentQuestion];
        html += `
          <div class="num-input">
            <input id="numInput" type="text" inputmode="decimal" placeholder="اكتب رقمًا..." value="${val ?? ""}" ${reviewMode ? "disabled": ""}/>
            <span class="note">يمكن استخدام النقطة أو الفاصلة العشرية.</span>
          </div>
          <div id="answerKey" style="margin-top:8px; display:${reviewMode ? "block":"none"}"></div>
        `;
      }

      questionBox.innerHTML = html;

      // خيارات MCQ
      if (q.type === "mcq") {
        const box = document.getElementById("choices");
        q.choices.forEach((choiceText, i) => {
          const label = document.createElement("label");
          label.className = "choice";
          if (reviewMode) {
            if (i === q.answerIndex) label.classList.add("correct");
            if (userAnswers[currentModule][currentQuestion] === i && i !== q.answerIndex) label.classList.add("wrong");
          }
          label.innerHTML = `
            <input type="radio" name="q${currentModule}-${currentQuestion}" value="${i}" ${userAnswers[currentModule][currentQuestion] === i ? "checked" : ""} ${reviewMode ? "disabled": ""}/>
            <span>${choiceText}</span>
          `;
          label.addEventListener("change", (e) => {
            userAnswers[currentModule][currentQuestion] = Number(e.target.value);
          });
          box.appendChild(label);
        });
      }

      // إدخال رقمي
      if (q.type === "numeric" && !reviewMode) {
        const inp = document.getElementById("numInput");
        inp.addEventListener("input", (e) => {
          const n = parseNumber(e.target.value);
          userAnswers[currentModule][currentQuestion] = n; // قد تكون null
        });
      }

      // مفتاح الإجابة في وضع المراجعة للأسئلة الرقمية
      if (q.type === "numeric" && reviewMode) {
        const ansKey = document.getElementById("answerKey");
        const userVal = userAnswers[currentModule][currentQuestion];
        const correctVal = Number(q.correctValue);
        const { tolerance = 0 } = (q.numericOptions || {});
        const correct = (userVal !== null) && approximatelyEqual(Number(userVal), correctVal, Number(tolerance));
        ansKey.innerHTML = `
          <div class="${correct ? 'correct' : 'wrong'}" style="padding:10px 12px; border:1px solid; border-radius:10px;">
            <div><b>الإجابة الصحيحة:</b> ${correctVal}</div>
            <div><b>إجابتك:</b> ${userVal === null ? "—" : userVal}</div>
            ${tolerance > 0 ? `<div class="note">يُقبل الفارق حتى ±${tolerance}</div>` : ""}
          </div>
        `;
      }

      // تقدم
      const overallIdx = globalIndex(currentModule, currentQuestion);
      progressText.textContent = `${mod.name} • السؤال ${currentQuestion + 1} من ${mod.questions.length} (إجمالي ${overallIdx} من ${totalQuestions})`;

      // أزرار
      const isFirstOverall = (currentModule === 0 && currentQuestion === 0);
      const isLastOverall = (currentModule === exam.modules.length - 1 && currentQuestion === mod.questions.length - 1);
      prevBtn.disabled = isFirstOverall;
      nextBtn.disabled = isLastOverall;

      // تعيين توقيت دخول السؤال (لتجميع زمن السؤال)
      lastEnterTimestamp = Date.now();
    }

    // =========================
    // 7) المؤقّت
    // =========================
    function startTimer() {
      timerEl.textContent = fmtTime(remainingSeconds);
      timerId = setInterval(() => {
        remainingSeconds--;
        timerEl.textContent = fmtTime(Math.max(0, remainingSeconds));
        if (remainingSeconds <= 0) {
          clearInterval(timerId);
          if (!reviewMode) {
            alert("انتهى الوقت! سيتم إنهاء الامتحان وعرض النتيجة.");
            finalizeAndShowResult();
          }
        }
      }, 1000);
    }

    // =========================
    // 8) التصحيح والنتيجة
    // =========================
    function grade() {
      let correct = 0, wrong = 0, unanswered = 0;
      const perModule = exam.modules.map(_ => ({ correct:0, wrong:0, unanswered:0, total:0 }));

      exam.modules.forEach((mod, mi) => {
        mod.questions.forEach((q, qi) => {
          perModule[mi].total++;
          const ans = userAnswers[mi][qi];
          if (q.type === "mcq") {
            if (ans === null) { unanswered++; perModule[mi].unanswered++; }
            else if (ans === q.answerIndex) { correct++; perModule[mi].correct++; }
            else { wrong++; perModule[mi].wrong++; }
          } else {
            if (ans === null) { unanswered++; perModule[mi].unanswered++; }
            else {
              const { tolerance = 0, decimals = null } = q.numericOptions || {};
              let userVal = Number(ans);
              let correctVal = Number(q.correctValue);
              if (decimals !== null && Number.isInteger(decimals)) {
                const factor = 10 ** decimals;
                userVal = Math.round(userVal * factor) / factor;
                correctVal = Math.round(correctVal * factor) / factor;
              }
              if (approximatelyEqual(userVal, correctVal, Number(tolerance))) {
                correct++; perModule[mi].correct++;
              } else {
                wrong++; perModule[mi].wrong++;
              }
            }
          }
        });
      });

      return { correct, wrong, unanswered, total: totalQuestions, perModule };
    }

    function finalizeAndShowResult() {
      // سجل الزمن الأخير لأولاً
      updateTimeSpent();

      reviewMode = true;
      submitBtn.disabled = true;
      endedAtISO = nowISO();

      const { correct, wrong, unanswered, total, perModule } = grade();
      const percent = Math.round((correct / total) * 100);

      let perModuleHtml = "";
      perModule.forEach((m, i) => {
        perModuleHtml += `
          <div>
            <b>${exam.modules[i].name}:</b>
            <span class="good">صحيح: ${m.correct}</span> ·
            <span class="bad">خطأ: ${m.wrong}</span> ·
            <span>غير مُجاب: ${m.unanswered}</span>
          </div>
        `;
      });

      const durationSec = TOTAL_SECONDS - remainingSeconds;

      resultEl.style.display = "block";
      resultEl.innerHTML = `
        <h2>النتيجة</h2>
        <div class="divider"></div>
        <p><b>الطالب:</b> ${student.name} · <b>الإيميل:</b> ${student.email} · <b>الهاتف:</b> ${student.phone}</p>
        <p><b>الوقت المستغرق:</b> ${fmtTime(durationSec)} من ${fmtTime(TOTAL_SECONDS)}</p>
        <div class="legend" style="margin-top:6px;">
          <span class="good">صحيح: ${correct}</span>
          <span class="bad">خطأ: ${wrong}</span>
          <span>غير مُجاب: ${unanswered}</span>
        </div>
        <p>الدرجة النهائية: <span class="tag">${percent}%</span> من ${total} سؤالًا</p>
        ${perModuleHtml}
        <div style="margin-top:12px;">
          <button id="downloadCsvBtn" class="btn secondary">تنزيل CSV</button>
        </div>
        <p class="muted" style="margin-top:8px;">تم تفعيل وضع المراجعة—سيظهر تمييز الأخضر للصحيح والأحمر للإجابات الخاطئة.</p>
      `;

      // إعادة رسم السؤال الحالي للمراجعة
      renderQuestion();

      // إيقاف المؤقت إن كان يعمل
      if (timerId) clearInterval(timerId);

      // ربط زر تنزيل CSV
      const btn = document.getElementById("downloadCsvBtn");
      btn.addEventListener("click", () => downloadCSV({ correct, wrong, unanswered, total, percent, durationSec }));
    }

    function downloadCSV(summary) {
      const headers = [
        "RecordType","StudentName","Email","Phone","StartTime","EndTime","DurationSeconds",
        "Module","QuestionNumber","Domain","Type","QuestionText","StudentAnswer","CorrectAnswer",
        "IsCorrect","TimeSpentSeconds","ScorePercent","CorrectTotal","WrongTotal","UnansweredTotal","TotalQuestions"
      ];

      const rows = [];
      // صف ملخّص
      rows.push([
        "SUMMARY", student.name, student.email, student.phone, startedAtISO, endedAtISO, summary.durationSec,
        "", "", "", "", "", "", "", "", "", summary.percent, summary.correct, summary.wrong, summary.unanswered, summary.total
      ]);

      // صفوف الأسئلة
      exam.modules.forEach((mod, mi) => {
        mod.questions.forEach((q, qi) => {
          const ans = userAnswers[mi][qi];
          let studentAnsStr = "";
          let correctAnsStr = "";
          let isCorrect = false;

          if (q.type === "mcq") {
            studentAnsStr = (ans === null) ? "" : String(q.choices[ans]);
            correctAnsStr = String(q.choices[q.answerIndex]);
            isCorrect = (ans !== null && ans === q.answerIndex);
          } else {
            const { tolerance = 0, decimals = null } = q.numericOptions || {};
            const userVal = (ans === null ? null : Number(ans));
            let correctVal = Number(q.correctValue);
            if (decimals !== null && Number.isInteger(decimals)) {
              const factor = 10 ** decimals;
              correctVal = Math.round(correctVal * factor) / factor;
            }
            studentAnsStr = (userVal === null ? "" : userVal);
            correctAnsStr = correctVal;
            isCorrect = (userVal !== null && approximatelyEqual(userVal, correctVal, Number(tolerance)));
          }

          rows.push([
            "QUESTION", student.name, student.email, student.phone, startedAtISO, endedAtISO, summary.durationSec,
            exam.modules[mi].name, (qi+1), q.domain, q.type, q.text.replace(/\n/g, " "),
            studentAnsStr, correctAnsStr, isCorrect ? "TRUE":"FALSE", timeSpent[mi][qi],
            "", "", "", "", ""
          ]);
        });
      });

      const csv = [headers.map(escapeCSV).join(","), ...rows.map(r => r.map(escapeCSV).join(","))].join("\n");
      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const a = document.createElement("a");
      const ts = new Date().toISOString().replace(/[-:T]/g,"").slice(0,14);
      const safeName = student.name.trim().replace(/\s+/g,"_").slice(0,30) || "Student";
      a.href = URL.createObjectURL(blob);
      a.download = `SAT_Math_Result_${safeName}_${ts}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // =========================
    // 9) الأحداث
    // =========================
    startBtn.addEventListener("click", () => {
      const name = nameInput.value.trim();
      const email = emailInput.value.trim();
      const phone = phoneInput.value.trim();

      // تحقق بسيط
      const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
      const digitsCount = (phone.replace(/\D/g,"").length);
      if (!name || name.length < 2) { alert("يرجى إدخال الاسم الكامل."); return; }
      if (!emailOk) { alert("يرجى إدخال بريد إلكتروني صالح."); return; }
      if (digitsCount < 7) { alert("يرجى إدخال رقم هاتف صالح (ويُفضّل مع مفتاح الدولة)."); return; }

      student.name = name; student.email = email; student.phone = phone;

      started = true;
      reviewMode = false;
      remainingSeconds = TOTAL_SECONDS;
      startedAtISO = nowISO();
      startScreen.style.display = "none";
      examContent.style.display = "block";
      renderQuestion();
      startTimer();
    });

    prevBtn.addEventListener("click", () => {
      const mod = exam.modules[currentModule];
      if (currentQuestion > 0) {
        navigateTo(currentModule, currentQuestion - 1);
      } else if (currentModule > 0) {
        const prevMod = currentModule - 1;
        navigateTo(prevMod, exam.modules[prevMod].questions.length - 1);
      }
    });

    nextBtn.addEventListener("click", () => {
      const mod = exam.modules[currentModule];
      if (currentQuestion < mod.questions.length - 1) {
        navigateTo(currentModule, currentQuestion + 1);
      } else if (currentModule < exam.modules.length - 1) {
        navigateTo(currentModule + 1, 0);
      }
    });

    submitBtn.addEventListener("click", () => {
      if (reviewMode) return;
      const ok = confirm("هل تريد إنهاء الامتحان وعرض النتيجة الآن؟ لن تتمكن من تعديل الإجابات بعد ذلك.");
      if (!ok) return;
      finalizeAndShowResult();
    });

    // تهيئة
    renderModulesBar();
    timerEl.textContent = fmtTime(remainingSeconds);
  </script>
</body>
</html>
